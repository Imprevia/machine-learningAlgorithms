# 条件随机场

# 概率无向图

概率无向图又称为马尔可夫随机场，它是一个联合概率分布，可以形象化地由无向图表示。

## 概率无向图的定义

图是由结点v和连接结点的边e组成的集合（如果了解数据结构，对图的概念会更清楚），结点和边的集合为V和E，整个图为$G=(V, E)$。图可以是有向的，也可以是无向的，有向指连接结点的边有方向的属性，而无向是指边没有方向的属性。

概率图模型是由图表示的概率分布。设有联合概率分布$P(Y)$，$Y\in \gamma$是一组随机变量，由无向图$G=(V，E)$表示概率分布$P(Y)$，即在图G中，结点$v \in V$表示一个随机变量$Y_v$，$Y=(Y_v)_{v \in V}$;边$e \in E$表示随机变量之间的概率依赖关系。

概率无向图的随机变量之间有成对马尔可夫性，局部马尔可夫性和全局马尔可夫性。

* 成对马尔可夫性

  设和$v$是无向图$G$中任意两个没有边连接的结点，结点$u$和$v$分别对应随机变量$Y_u$,和$Y_v$。其他所有结点为$O$,对应的随机变量组是$Y_O$。成对马尔可夫性是指给定随机变量组$Y_O$的条件下随机变量$Y_u$和$Y_v$是条件独立的，即
  $$
  P\left(Y_{u}， Y_{v} \mid Y_{o}\right)=P\left(Y_{u} \mid Y_{o}\right) P\left(Y_{v} \mid Y_{o}\right)
  $$

* 局部马尔可夫性

  局部马尔可夫性：设$v\in V$是无向图$G$中任意一个结点，$W$是与$v$有边连接的所有结点，$O$是$v$，$W$以外的其他所有结点。$v$表示的随机变量是$Y_v$，$W$表示的随机变量组是$Y_W$，$O$表示的随机变量组是$Y_O$。局部马尔可夫性是指在给定随机变量组$Y_W$的条件下随机变量$Y_v$与随机变量组$Y_O$。是独立的，即
  $$
  P\left(Y_{v}， Y_{o} \mid Y_{W}\right)=P\left(Y_{v} \mid Y_{W}\right) P\left(Y_{O} \mid Y_{W}\right)
  $$
  在$P(Y_O|Y_W) > 0 $时，等价，
  $$
  P(Y_O|Y_W) = P\left(Y_{v}， Y_{o} \mid Y_{W}\right)
  $$

* 全局马尔可夫性

  全局马尔可夫性:设结点集合$A，B$是在无向图G中被结点集合C分开的任意结点集合，如下图所示,结点集合$A，B$和$C$所对应的随机变量组分别是$Y_A$和$Y_C$。全局马尔可夫性是指给定随机变量组$Y_C$条件下随机变量组$Y_A$和$Y_B$是条件独立的，即
  $$
  P\left(Y_{A}， Y_{B} \mid Y_{C}\right)=P\left(Y_{A} \mid Y_{C}\right) P\left(Y_{B} \mid Y_{C}\right)
  $$
  

  ![image-20240229180522913](.\images\11.2.png)

## 因子分解

给定概率无向图模型，设其无向图为$G$，$C$为$G$上的最大团，$Y_C表示$$C$对应的随机变量。那么概率无向图模型的联合概率分布$P(Y)$可写作图中所有最大团$C$上的函数$\Psi_{C}\left(Y_{C}\right)$的乘积形式，即
$$
P(Y)=\frac{1}{Z} \prod_{c} \Psi_{C}\left(Y_{C}\right) 
$$
其中Z是规范化因子：
$$
Z=\sum_{Y} \prod_{C} \Psi_{C}\left(Y_{C}\right) 
$$
为了保证$P(Y)$为概率。 $\Psi_{C}\left(Y_{C}\right)$为势函数，要求势函数必须为正，即严格正的，因此势函数通常使用指数函数：
$$
\Psi_{C}\left(Y_{C}\right)=\exp \left\{-E\left(Y_{C}\right)\right\} 
$$


# 条件随机场

条件随机场是给定随机变量X条件下，随机变量Y的马尔可夫随机场。条件随机场有非常多的形式，这里主要介绍定义在线性链上的特殊的条件随机场，称为线性链条件随机场。

线性链条件随机场用于标注问题，在条件概率模型$P(Y|X)$中，Y是输出变量，表示标记序列，也称为状态序列。$X$是输入变量，表示需要标注的观测序列。学习时，利用训练数据集通过极大似然估计或正则化的极大似然估计得到条件概率模型${\hat P}(Y \mid X) $。预测时，对于给定的输入序列x，求出条件概率${\hat P}(Y \mid X) $ 最大的输出序列$\hat{y}$。

设X与Y是随机变量，$P(Y|X)$是在给定X的条件下$Y$的条件概率分布。若随机变量$Y$构成一个由无向图$G=(V, E)$表示的马尔可夫随机场：
$$
P\left(Y_{v} \mid X， Y_{w}， \quad w \neq v\right)=P\left(Y_{v} \mid X， Y_{w}， w \sim v\right)
$$
对任意结点v成立，则称条件概率分布$P(Y|X)$为条件随机场。式中w≠v表示结点v以外的所有结点，$w\ne v$表示在图$G=(V, E)$中与结点$v$有边连接的所有结点$w$。

在定义中并没有要求X和Y具有相同的结构。现实中，一般假设X和Y有相同的图结构。我们主要考虑的线性链情况如下：

![image-20240229200030792](.\images\11.5.png)

可以用下式表述上面的两种情况：
$$
G=(V=\{1，2， \cdots， n\}， E=\{(i， i+1)\})， i=1，2， \cdots， n-1 
$$
容易理解，$V$是图$G$中的所有结点的集合，$E$是所有边的集合，每个边使用该边连接的两个点来表示，比如对于结点1和2，连接它们的边为$(1, 2)$，显然，在上图的两种情况中，$E={(1, 2), (2, 3), \cdots , (n-1, n)}$。

这样，就可以对线性链条件随机场做一个数学上的定义了：

设$X=(X1,X2,\cdots ,Xn),Y=(Y1,Y2,\cdots ,Yn)$均为线性链表示的随机变量序列，若在给定随机变量序列X的条件下，随机变量序列Y的的条件概率分布$P(Y|X)$构成条件随机场，即满足马尔可夫性：
$$
P\left(Y_{i} \mid X， Y_{1}， \cdots， Y_{i-1}， Y_{i+1}， \cdots， Y_{n}\right)=P\left(Y_{i} \mid X， Y_{i-1}， Y_{i+1}\right) 
$$

$$
i=1，2， \cdots， n( 在 i=1  时只考虑单边 ) 
$$

在标注问题中，X表示输入观测序列，Y表示对应的输出标记序列或状态序列。



## 条件随机场的参数化形式

根据计算条件随机场的联合概率公式：
$$
P(Y)=\frac{1}{Z} \prod_{c} \Psi_{C}\left(Y_{C}\right) \\\Psi_{C}\left(Y_{C}\right)=\exp \left\{-E\left(Y_{C}\right)\right\}
$$
可以推得在随机变量X取值为x的条件下，随机变量Y取值为y的条件概率：
$$
P(y \mid x)=\frac{1}{Z(x)} \exp \left(\sum_{i， k} \lambda_{k} t_{k}\left(y_{i-1}， y_{i}， x， i\right)+\sum_{i， l} \mu_{l} s_{l}\left(y_{i}， x， i\right)\right) 
$$
其中$t_k$是定义在无向边上的特征函数，称为转移特征，依赖于当前和前一个位置。$s_l$是定义在结点上的特征函数，称为状态特征，依赖于当前位置。$t_k$和$s_l$都依赖于位置，是局部特征函数。通常，特征函数$t_k$和$s_l$取值为1或0，当满足特征条件时取值为1，否则为0。条件随机场完全由特征函数$t_k$，$s_l$和对应的权值$\lambda_k$，$\mu_l$确定。



## 条件随机场的简化形式：

思想就是将转移特征和状态特征合并，使用一个统一的符号表示，将转移特征的权值和状态特征的权值合并，使用一个统一的符号表示，接着将两者进行内积计算即可。

设有K个转移特征，$K_2$个状态特征，则$K=K1+K2$。

将转移特征和状态特征合并，使用一个统一的符号表示：
$$
f_{k}\left(y_{i-1}， y_{i}， x， i\right)=\left\{\begin{array}{ccc}t_{k}\left(y_{i-1}， y_{i}， x，i \right)， & k=1，2， \cdots， K_{1} \\ s_{l}\left(y_{i}， x， i\right)， & k=K_{1}+l ； l=1， 2， \cdots， K_{2}\end{array}\right.
$$
然后，对转移与状态特征在各个位置求和：
$$
f_{k}(y， x)=\sum_{i=1}^{n} f_{k}\left(y_{i-1}， y_{i}， x， i\right)， k=1，2， \cdots， K 
$$
将转移特征的权值和状态特征的权值合并，使用一个统一的符号表示：
$$
w_{k}=\left\{\begin{array}{lr}\lambda_{k}， & k=1，2， \cdots， K_{1} \\ \mu_{l}， & k=K_{1}+l ； l=1，2， \cdots， K_{2}\end{array}\right.
$$
接着将两者进行内积计算，就得到了条件随机场的简化形式：
$$
P(y \mid x)=\frac{1}{Z(x)} \exp \sum_{k=1}^{K} w_{k} f_{k}(y， x) 
$$
## 条件随机场的矩阵形式

引进特殊的起点和终点状态标记，$y_0=start，y_{n+1}=stop$。

对观测序列x的每一个位置$i=1,2,\cdots,n+1,$定义一个m阶矩阵(m是标记$y_i$取值的个数)
$$
M_{i}(x)=\left[M_{i}\left(y_{i-1}， y_{i} \mid x\right)\right] \\
M_{i}\left(y_{i-1}， y_{i} \mid x\right)=\exp \left(W_{i}\left(y_{i-1}， y_{i} \mid x\right)\right) \\
W_{i}\left(y_{i-1}， y_{i} \mid x\right)=\sum_{k=1}^{K} w_{k} f_{k}\left(y_{i-1}， y_{i}， x， i\right) 
$$
这样，给定观测序列$x$，标记序列$y$的非规范化概率可以通过$n+1$个矩阵的乘积$\prod_{i=1}^{n+1}M_i(y_{i=1},y_i|x)$表示，于是，条件概率$P_w(y|x)$是
$$
P_{w}(y \mid x)=\frac{1}{Z_{w}(x)} \prod_{i=1}^{n+1} M_{i}\left(y_{i-1}， y_{i} \mid x\right)
$$
其中Z为：
$$
Z_{w}(x)=\left[M_{1}(x) M_{2}(x) \cdots M_{n+1}(x)\right]_{\text {start,stop}}  
$$

# 概率计算问题

条件随机场的概率计算问题是给定条件随机场$P(Y|X)$，输入序列x和输出序列y，计算条件概率$P\left(Y_{i}=y_{i} \mid x\right)，P\left(Y_{i-1}=y_{i-1}，Y_{i}=y_{i} \mid x\right) $以及相应的数学期望的问题。

## 前向-后向算法

对每个指标$i=0, 1, \cdots, n+1$，定义前向向量$α_i(x)$：
$$
a_{0}(y \mid x)=\left\{\begin{array}{lr}1， & y=\text { start } \\ 0， & \text { 否则 }\end{array}\right. 
$$
递推公式：
$$
a_{i}^{\mathrm{T}}\left(y_{i} \mid x\right)=\alpha_{i-1}^{\mathrm{T}}\left(y_{i-1} \mid x\right)\left[M_{i}\left(y_{i-1}， y_{i} \mid x\right)\right]， \quad i=1，2， \cdots， n+1 
$$
也可表示为：
$$
a_{i}^{\mathrm{T}}(x)=\alpha_{i-1}^{\mathrm{T}}(x) M_{i}(x)
$$
$a_{i}\left(y_{i} \mid x\right)$表示位置为i，且位置i的标记为$y_i$，并且从1到i的前部分标记序列的非规范化概率。比如从1到4的标记为(1, 2, 2, 1)，那么$a_4(1|x)$，即在第四个位置，$y_4=1$，且$y_1=1$, $y_2=2$, $y_3=2$, $y_4=1$的非规范化概率。

注意在上式的等号右边 ，$ M_{i}\left(y_{i-1}， y_{i} \mid x\right)$ 是矩阵中的一个元素，而非矩阵本身。$a_1$显然为第一个矩阵中的一个元素，因此每一个$a_i$都是由从1到i，一共i个矩阵中的某个元素相乘得到的，使用的矩阵中某个元素的位置由$y(i-1)$和$y_i$的值确定。

对每个指标$i=0, 1, \cdots, n+1$，定义后向概率：
$$
\beta_{n+1}\left(y_{n+1} \mid x\right)=\left\{\begin{array}{cc}1， & y_{n+1}=\text { stop } \\ 0， & \text { 否则 }\end{array}\right. 
$$
递推公式
$$
\beta_{i}\left(y_{i} \mid x\right)=\left[M_{i+1}\left(y_{i}， y_{i+1} \mid x\right)\right] \beta_{i+1}\left(y_{i+1} \mid x\right) 
$$
也可表示为：
$$
\beta_{i}(x)=M_{i+1}(x) \beta_{i+1}(x)
$$
后向概率是由i+1到n的后部分标记序列的非规范化概率。比如从1到4的标记为(1, 2, 2, 1)，那么$\beta_{2}(2|x)$为，在第2个位置，$y_2=2$，且$y_3=2$, $y_4=1$的非规范化概率，同样由各个对应矩阵中的元素相乘得到。

那么在位置i，其标记为$y_i$的条件概率为：
$$
P\left(Y_{i}=y_{i} \mid x\right)=\frac{\alpha_{i}^{\mathrm{T}}\left(y_{i} \mid x\right) \beta_{i}\left(y_{i} \mid x\right)}{Z(x)} 
$$
在位置$i-1$与$i$，两个位置的标记为$y(i-1)$和$y_i$的条件概率为：
$$
P\left(Y_{i-1}=y_{i-1}， Y_{i}=y_{i} \mid x\right)=\frac{\alpha_{i-1}^{\mathrm{T}}\left(y_{i-1} \mid x\right) M_{i}\left(y_{i-1}， y_{i} \mid x\right) \beta_{i}\left(y_{i} \mid x\right)}{Z(x)} 
$$
其中
$$
Z(x)=\alpha_{n}^{\mathrm{T}}(x) \mathbf{1}=\mathbf{1} \beta_{1}(x)
$$
$1$是元素均为1的m维列向量。

# 学习问题